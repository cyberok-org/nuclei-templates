id: CVE-2022-42475-safecheck

info:
  name: Fortinet FortiOS - Out-of-bounds Write vulnerability
  author: plgvkr
  severity: critical
  description: |
     A out-of-bounds write in Fortinet FortiOS and FortiProxy allows attacker to execute unauthorized code or commands via specifically crafted requests
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2022-42475
    - https://www.fortiguard.com/psirt/FG-IR-22-398
    - https://labs.watchtowr.com/fortinet-no-more-funny-titles-cve-2022-42475/
    - https://bishopfox.com/blog/exploit-cve-2022-42475
    - https://blog.scrt.ch/2023/03/14/producing-a-poc-for-cve-2022-42475-fortinet-rce/
  classification:
    cve-id: CVE-2022-42475
    cvss-score: 9.8
    epss-score: 0.32117
    cpe: cpe:2.3:o:fortinet:fortios:*:*:*:*:*:*:*:*
  metadata:
    date: 14.06.2024
    expiration_date: 14.09.2024
    code_requirements:
    additional_files:
    nuclei_commandline: -V UA="Mozilla/5.0 (compatible; CyberOKInspect/1.0; +https://www.cyberok.ru/policy.html)"
    bdu-id:
    cok-id:
    template_type: safecheck
    verified: false
    shodan-query: |
      "Server: xxxxxxxx-xxxxx" http.html:"top.location=/remote/login"
      http.favicon.hash:945408572,1940749784,210067285,1831090614,1927857756,-2013924196
    netlas-query: |
      http.headers.server:"xxxxxxxx-xxxxx" OR tag.name:(fortinet OR fortigate_vpn)
    rooster-query: |
      product.name:"fortios"
    fofa-query: |
      app="FORTINET-SSLVPN" || server="xxxxxxxx-xxxxx" || icon_hash="945408572" || icon_hash="1940749784" || icon_hash="210067285" || icon_hash="1831090614" || icon_hash="1927857756" || icon_hash="-2013924196"
    censys-query: |
      services.http.response.headers: (key: "Server" and value.headers: "xxxxxxxx-xxxxx")
    hunter-how: |
      header.server="xxxxxxxx-xxxxx" and product.name=="Fortinet Client"
    max-request: 1
    vendor: fortinet
    product: fortios    
    accuracy: 0.7
    damage: 1
  tags: cve-2022-42475,forti,fortinet,fortios,fortiproxy

variables:
  UA:
    description: User-Agent header
    type: string
    required: true

flow: http(1) && tcp(1)

http:
 - method: GET
   path:
     - "{{BaseURL}}/"

   matchers:
     - type: dsl
       internal: true
       dsl:
         - contains(to_lower(header),"xxxxxxxx-xxxxx")
         - contains(to_lower(body),"\/remote\/login")
       condition: and

tcp:
  - inputs:
      - data: "POST /remote/error HTTP/1.1\r\nHost: {{Hostname}}\r\nUser-Agent: {{UA}}\r\nAccept: */*\r\nContent-Length: 1048577\r\nContent-Type: application/x-www-form-urlencoded\r\n\r\n"
    host:
    - "tls://{{Hostname}}"
    read-size: 256

    matchers:
    - type: word
      name: CVE-2022-42475
      negative: true
      words:
        - "HTTP/1.1 413"
